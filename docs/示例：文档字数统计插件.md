---
title: ç¤ºä¾‹ï¼šæ–‡æ¡£å­—æ•°ç»Ÿè®¡æ’ä»¶
date: 2026-01-11T16:15:40Z
lastmod: 2026-01-11T16:18:23Z
---

# ç¤ºä¾‹ï¼šæ–‡æ¡£å­—æ•°ç»Ÿè®¡æ’ä»¶

è¿™æ˜¯ä¸€ä¸ªç¬”è®°å†…æ’ä»¶ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä¸ºæ€æºç¬”è®°æ·»åŠ ä¸€ä¸ªå®æ—¶å­—æ•°ç»Ÿè®¡é¢æ¿ã€‚å½“æ¿€æ´»åï¼Œä¼šåœ¨çŠ¶æ€æ æ˜¾ç¤ºå½“å‰æ–‡æ¡£çš„å­—æ•°ã€æ®µè½æ•°ç­‰ä¿¡æ¯ã€‚

## æ’ä»¶é…ç½®

è®¾ç½®ä»¥ä¸‹æ–‡æ¡£å±æ€§åï¼Œæ­¤æ–‡æ¡£å³å¯ä½œä¸ºç¬”è®°å†…æ’ä»¶è¿è¡Œï¼š

- â€‹`ext-type`â€‹: `plugin`
- â€‹`ext-lang`â€‹: `js`

## åŠŸèƒ½è¯´æ˜

- ğŸ”¢ å®æ—¶ç»Ÿè®¡å½“å‰æ–‡æ¡£å­—æ•°ã€è¯æ•°ã€æ®µè½æ•°
- ğŸ“Š åœ¨çŠ¶æ€æ æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
- ğŸ”„ è‡ªåŠ¨æ›´æ–°ï¼ˆæ–‡æ¡£å†…å®¹å˜åŒ–æ—¶ï¼‰
- âš™ï¸ ç‚¹å‡»çŠ¶æ€æ å›¾æ ‡å¯æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡

## æ’ä»¶ä»£ç 

```javascript
// å¯¼å…¥æ€æºæ’ä»¶API
import { Plugin, showMessage, confirm } from "siyuan";

/**
 * æ–‡æ¡£ç»Ÿè®¡æ’ä»¶
 * åœ¨çŠ¶æ€æ æ˜¾ç¤ºå½“å‰æ–‡æ¡£çš„å­—æ•°ç»Ÿè®¡ä¿¡æ¯
 */
export default class WordCountPlugin extends Plugin {
    // çŠ¶æ€æ å…ƒç´ 
    statusBarElement = null;
    // å®šæ—¶å™¨ID
    updateTimer = null;
    // ä¸Šæ¬¡ç»Ÿè®¡çš„æ–‡æ¡£ID
    lastDocId = null;

    /**
     * æ’ä»¶åŠ è½½æ—¶è°ƒç”¨
     */
    async onload() {
        console.log("[WordCount] æ’ä»¶å·²åŠ è½½");
        
        // æ·»åŠ çŠ¶æ€æ æŒ‰é’®
        this.statusBarElement = this.addStatusBar({
            element: this.createStatusBarElement(),
            position: "right"
        });

        // ç›‘å¬æ–‡æ¡£åˆ‡æ¢äº‹ä»¶
        this.eventBus.on("switch-protyle", this.handleDocSwitch.bind(this));
        
        // ç›‘å¬æ–‡æ¡£å†…å®¹å˜åŒ–
        this.eventBus.on("loaded-protyle-static", this.handleDocLoaded.bind(this));
        
        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡ï¼‰
        this.updateTimer = setInterval(() => {
            this.updateStatistics();
        }, 5000);

        showMessage("å­—æ•°ç»Ÿè®¡æ’ä»¶å·²å¯ç”¨ ğŸ“Š", 2000);
    }

    /**
     * æ’ä»¶å¸è½½æ—¶è°ƒç”¨
     */
    async onunload() {
        console.log("[WordCount] æ’ä»¶å·²å¸è½½");
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (this.updateTimer) {
            clearInterval(this.updateTimer);
            this.updateTimer = null;
        }
        
        showMessage("å­—æ•°ç»Ÿè®¡æ’ä»¶å·²ç¦ç”¨", 2000);
    }

    /**
     * åˆ›å»ºçŠ¶æ€æ å…ƒç´ 
     */
    createStatusBarElement() {
        const container = document.createElement("div");
        container.className = "wordcount-status";
        container.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 0 8px;
            font-size: 12px;
            color: var(--b3-theme-on-surface);
        `;
        container.innerHTML = `
            <svg class="b3-menu__icon" style="width: 14px; height: 14px;">
                <use xlink:href="#iconFile"></use>
            </svg>
            <span class="wordcount-text">ç»Ÿè®¡ä¸­...</span>
        `;
        
        // ç‚¹å‡»æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
        container.addEventListener("click", () => {
            this.showDetailedStats();
        });
        
        return container;
    }

    /**
     * å¤„ç†æ–‡æ¡£åˆ‡æ¢
     */
    handleDocSwitch(event) {
        const protyle = event?.detail?.protyle;
        if (protyle?.block?.rootID) {
            this.lastDocId = protyle.block.rootID;
            this.updateStatistics();
        }
    }

    /**
     * å¤„ç†æ–‡æ¡£åŠ è½½å®Œæˆ
     */
    handleDocLoaded(event) {
        setTimeout(() => {
            this.updateStatistics();
        }, 500);
    }

    /**
     * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
     */
    async updateStatistics() {
        // è·å–å½“å‰æ‰“å¼€çš„ç¼–è¾‘å™¨
        const protyle = this.getCurrentProtyle();
        if (!protyle) {
            this.updateStatusBar("æœªæ‰“å¼€æ–‡æ¡£");
            return;
        }

        const rootId = protyle.block?.rootID;
        if (!rootId) {
            this.updateStatusBar("æ— æ–‡æ¡£");
            return;
        }

        try {
            // ä½¿ç”¨å†…æ ¸APIè·å–æ–‡æ¡£å†…å®¹
            const response = await fetch("/api/export/exportMdContent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: rootId })
            });
            
            const result = await response.json();
            if (result.code === 0 && result.data?.content) {
                const stats = this.calculateStats(result.data.content);
                this.updateStatusBar(
                    `${stats.chars} å­— | ${stats.words} è¯ | ${stats.paragraphs} æ®µ`
                );
                // ä¿å­˜è¯¦ç»†ç»Ÿè®¡ä¾›ç‚¹å‡»æŸ¥çœ‹
                this.detailedStats = stats;
            }
        } catch (error) {
            console.error("[WordCount] ç»Ÿè®¡å¤±è´¥:", error);
            this.updateStatusBar("ç»Ÿè®¡å¤±è´¥");
        }
    }

    /**
     * è®¡ç®—æ–‡æœ¬ç»Ÿè®¡
     */
    calculateStats(markdown) {
        // ç§»é™¤Markdownæ ‡è®°åè®¡ç®—
        const plainText = markdown
            .replace(/â€```[\s\S]*?â€```/g, "")  // ç§»é™¤ä»£ç å—
            .replace(/`[^`]+`/g, "")          // ç§»é™¤è¡Œå†…ä»£ç 
            .replace(/!\[.*?\]\(.*?\)/g, "") // ç§»é™¤å›¾ç‰‡
            .replace(/\[.*?\]\(.*?\)/g, "$1") // é“¾æ¥åªä¿ç•™æ–‡æœ¬
            .replace(/[#*_~\[\]]/g, "")      // ç§»é™¤æ ¼å¼æ ‡è®°
            .replace(/\n+/g, "\n")            // åˆå¹¶ç©ºè¡Œ
            .trim();

        // å­—ç¬¦æ•°ï¼ˆä¸å«ç©ºæ ¼ï¼‰
        const chars = plainText.replace(/\s/g, "").length;
        
        // ä¸­æ–‡è¯æ•°ä¼°ç®—ï¼ˆä¸­æ–‡æ¯ä¸ªå­—ç®—ä¸€ä¸ªè¯ï¼‰ï¼Œè‹±æ–‡æŒ‰ç©ºæ ¼åˆ†è¯
        const chineseChars = (plainText.match(/[\u4e00-\u9fa5]/g) || []).length;
        const englishWords = (plainText.match(/[a-zA-Z]+/g) || []).length;
        const words = chineseChars + englishWords;
        
        // æ®µè½æ•°
        const paragraphs = plainText.split(/\n+/).filter(p => p.trim()).length;
        
        // è¡Œæ•°
        const lines = markdown.split(/\n/).length;
        
        // é˜…è¯»æ—¶é—´ä¼°ç®—ï¼ˆä¸­æ–‡300å­—/åˆ†é’Ÿï¼Œè‹±æ–‡200è¯/åˆ†é’Ÿï¼‰
        const readingMinutes = Math.ceil((chineseChars / 300) + (englishWords / 200));

        return {
            chars,
            words,
            paragraphs,
            lines,
            chineseChars,
            englishWords,
            readingMinutes
        };
    }

    /**
     * æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
     */
    updateStatusBar(text) {
        const textEl = this.statusBarElement?.querySelector(".wordcount-text");
        if (textEl) {
            textEl.textContent = text;
        }
    }

    /**
     * è·å–å½“å‰ç¼–è¾‘å™¨
     */
    getCurrentProtyle() {
        // å°è¯•ä»å…¨å±€è·å–å½“å‰æ´»åŠ¨çš„protyle
        const layouts = window.siyuan?.layout?.centerLayout;
        if (!layouts) return null;
        
        // é€’å½’æŸ¥æ‰¾æ´»åŠ¨çš„ç¼–è¾‘å™¨
        const findActiveEditor = (layout) => {
            if (layout.children) {
                for (const child of layout.children) {
                    const result = findActiveEditor(child);
                    if (result) return result;
                }
            }
            if (layout.model?.editor?.protyle) {
                return layout.model.editor.protyle;
            }
            return null;
        };
        
        return findActiveEditor(layouts);
    }

    /**
     * æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡å¯¹è¯æ¡†
     */
    async showDetailedStats() {
        if (!this.detailedStats) {
            showMessage("æš‚æ— ç»Ÿè®¡æ•°æ®ï¼Œè¯·å…ˆæ‰“å¼€æ–‡æ¡£", 2000);
            return;
        }

        const stats = this.detailedStats;
        const message = `
ğŸ“Š **æ–‡æ¡£ç»Ÿè®¡è¯¦æƒ…**

| é¡¹ç›® | æ•°é‡ |
|------|------|
| æ€»å­—ç¬¦æ•° | ${stats.chars} |
| æ€»è¯æ•° | ${stats.words} |
| ä¸­æ–‡å­—ç¬¦ | ${stats.chineseChars} |
| è‹±æ–‡å•è¯ | ${stats.englishWords} |
| æ®µè½æ•° | ${stats.paragraphs} |
| æ€»è¡Œæ•° | ${stats.lines} |
| é¢„è®¡é˜…è¯» | ${stats.readingMinutes} åˆ†é’Ÿ |
        `.trim();

        // ä½¿ç”¨confirmæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        await confirm(
            "ğŸ“Š æ–‡æ¡£ç»Ÿè®¡",
            `<div style="font-family: monospace; line-height: 1.8;">
                <p><strong>æ€»å­—ç¬¦:</strong> ${stats.chars}</p>
                <p><strong>æ€»è¯æ•°:</strong> ${stats.words}</p>
                <p><strong>ä¸­æ–‡å­—ç¬¦:</strong> ${stats.chineseChars}</p>
                <p><strong>è‹±æ–‡å•è¯:</strong> ${stats.englishWords}</p>
                <p><strong>æ®µè½æ•°:</strong> ${stats.paragraphs}</p>
                <p><strong>æ€»è¡Œæ•°:</strong> ${stats.lines}</p>
                <p><strong>é¢„è®¡é˜…è¯»:</strong> ${stats.readingMinutes} åˆ†é’Ÿ</p>
            </div>`
        );
    }
}
```

## ä½¿ç”¨è¯´æ˜

1. **è®¾ç½®å±æ€§**ï¼š

   - æ‰“å¼€æ­¤æ–‡æ¡£ï¼ŒæŒ‰ `Ctrl+Shift+A`â€‹ æˆ–ç‚¹å‡»å³ä¸Šè§’ `Â·Â·Â·`â€‹ â†’ `å±æ€§`
   - æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼š

     - â€‹`ext-type`â€‹ = `plugin`
     - â€‹`ext-lang`â€‹ = `js`
2. **å¯ç”¨æ’ä»¶**ï¼š

   - å³é”®ç‚¹å‡»æ–‡æ¡£æ ‘ä¸­çš„æ­¤æ–‡æ¡£
   - é€‰æ‹©"æ³¨å†Œä¸ºç¬”è®°å†…æ’ä»¶"
   - æ’ä»¶å°†è‡ªåŠ¨åŠ è½½å¹¶åœ¨çŠ¶æ€æ æ˜¾ç¤ºå­—æ•°ç»Ÿè®¡
3. **æŸ¥çœ‹ç»Ÿè®¡**ï¼š

   - çŠ¶æ€æ å³ä¾§ä¼šæ˜¾ç¤ºç®€è¦ç»Ÿè®¡ï¼š`123 å­— | 45 è¯ | 6 æ®µ`
   - ç‚¹å‡»çŠ¶æ€æ ç»Ÿè®¡åŒºåŸŸå¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
4. **ç¦ç”¨æ’ä»¶**ï¼š

   - åœ¨æ’ä»¶ç®¡ç†ç•Œé¢ç¦ç”¨å³å¯

## æ‰©å±•æ€è·¯

ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•æ›´å¤šåŠŸèƒ½ï¼š

- ğŸ“ æ·»åŠ å†™ä½œç›®æ ‡è®¾å®šï¼ˆå¦‚æ¯æ—¥1000å­—ï¼‰
- ğŸ“ˆ è®°å½•å†™ä½œå†å²å’Œè¶‹åŠ¿å›¾è¡¨
- â±ï¸ æ·»åŠ å†™ä½œè®¡æ—¶å™¨/ç•ªèŒ„é’Ÿ
- ğŸ”” å­—æ•°è¾¾æ ‡æé†’
- ğŸ“Š å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š

â€

â€
