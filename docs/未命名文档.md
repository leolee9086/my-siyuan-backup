---
title: æœªå‘½åæ–‡æ¡£
date: 2026-01-11T02:17:08Z
lastmod: 2026-01-11T02:27:07Z
---

# æœªå‘½åæ–‡æ¡£

# ç¤ºä¾‹ï¼šè‡ªåŠ¨ Git æ¨é€æ›´æ–°çš„æ–‡æ¡£

è¿™æ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ï¼š

1. æ¯ 10 åˆ†é’Ÿæ£€æŸ¥æœ€è¿‘æ›´æ–°çš„æ–‡æ¡£
2. å°†æ–‡æ¡£å¯¼å‡ºä¸º Markdown åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
3. ä½¿ç”¨ Git æäº¤å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“

> âš ï¸ **å®‰å…¨æç¤º**ï¼šæ­¤ä»»åŠ¡ä¼šè°ƒç”¨å¤–éƒ¨å‘½ä»¤ï¼ˆgitï¼‰ï¼Œé¦–æ¬¡æ‰§è¡Œæ—¶ä¼šå¼¹å‡ºæˆæƒç¡®è®¤å¯¹è¯æ¡†ã€‚

## ä»»åŠ¡é…ç½®

```go
package main

import (
	"fmt"
	"path/filepath"
	"time"

	"safeos"
	"safeexec"
	"siyuan"
)

// ä»»åŠ¡åç§°
var Name = "è‡ªåŠ¨ Git æ¨é€"

// ä»»åŠ¡æè¿°
var Description = "æ¯ 10 åˆ†é’Ÿæ£€æŸ¥æ›´æ–°çš„æ–‡æ¡£ï¼Œå¯¼å‡ºå¹¶æ¨é€åˆ° Git ä»“åº“"

// Cron è¡¨è¾¾å¼ï¼šæ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
var Schedule = "*/10 * * * *"

// ========== ç”¨æˆ·é…ç½® ==========

// Git ä»“åº“ç›®å½•ï¼ˆå¿…é¡»æ˜¯å·²åˆå§‹åŒ–çš„ Git ä»“åº“ï¼‰
var GitRepoDir = "D:/notes/my-siyuan-backup"

// å¯¼å‡ºå­ç›®å½•ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼‰
var ExportSubDir = "docs"

// è¿œç¨‹ä»“åº“åç§°
var GitRemote = "origin"

// åˆ†æ”¯åç§°
var GitBranch = "main"

// æŸ¥è¯¢å¤šä¹…å†…æ›´æ–°çš„æ–‡æ¡£ï¼ˆåˆ†é’Ÿï¼‰
var UpdatedWithinMinutes = 10

// ========== ä»»åŠ¡é€»è¾‘ ==========

// Run ä»»åŠ¡å…¥å£å‡½æ•°
func Run(ctx *siyuan.Context) error {
	exportDir := filepath.Join(GitRepoDir, ExportSubDir)

	// 1. ç¡®ä¿å¯¼å‡ºç›®å½•å­˜åœ¨
	if err := safeos.MkdirAll(exportDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºå¯¼å‡ºç›®å½•å¤±è´¥: %v", err)
	}

	// 2. æŸ¥è¯¢æœ€è¿‘æ›´æ–°çš„æ–‡æ¡£
	// è®¡ç®—æ—¶é—´é˜ˆå€¼
	threshold := time.Now().Add(-time.Duration(UpdatedWithinMinutes) * time.Minute)
	thresholdStr := threshold.Format("20060102150405")

	stmt := fmt.Sprintf(
		"SELECT id, content FROM blocks WHERE type = 'd' AND updated > '%s' ORDER BY updated DESC LIMIT 50",
		thresholdStr,
	)

	ret, err := ctx.Call("/api/query/sql", map[string]interface{}{
		"stmt": stmt,
	})
	if err != nil {
		return fmt.Errorf("æŸ¥è¯¢æ–‡æ¡£å¤±è´¥: %v", err)
	}

	dataList, ok := ret["result"].([]interface{})
	if !ok || len(dataList) == 0 {
		siyuan.æ—¥å¿—ä¿¡æ¯("æ²¡æœ‰å‘ç°æ›´æ–°çš„æ–‡æ¡£ï¼Œè·³è¿‡æœ¬æ¬¡åŒæ­¥")
		return nil
	}

	siyuan.æ—¥å¿—ä¿¡æ¯(fmt.Sprintf("å‘ç° %d ä¸ªæ›´æ–°çš„æ–‡æ¡£", len(dataList)))

	// 3. é€ä¸ªå¯¼å‡ºæ–‡æ¡£
	exportedCount := 0
	for _, item := range dataList {
		row := item.(map[string]interface{})
		docID := row["id"].(string)
		docTitle := row["content"].(string)

		// è°ƒç”¨å¯¼å‡º API
		retExport, err := ctx.Call("/api/export/exportMdContent", map[string]interface{}{
			"id": docID,
		})
		if err != nil {
			siyuan.æ—¥å¿—è­¦å‘Š(fmt.Sprintf("å¯¼å‡ºæ–‡æ¡£ %s å¤±è´¥: %v", docTitle, err))
			continue
		}

		mdContent, _ := retExport["content"].(string)
		if mdContent == "" {
			continue
		}

		// ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
		safeTitle := sanitizeFilename(docTitle)
		if safeTitle == "" {
			safeTitle = docID
		}
		filename := safeTitle + ".md"
		fullPath := filepath.Join(exportDir, filename)

		// å†™å…¥æ–‡ä»¶
		if err := safeos.WriteFile(fullPath, []byte(mdContent), 0644); err != nil {
			siyuan.æ—¥å¿—è­¦å‘Š(fmt.Sprintf("å†™å…¥æ–‡ä»¶ %s å¤±è´¥: %v", filename, err))
			continue
		}

		exportedCount++
		siyuan.æ—¥å¿—ä¿¡æ¯(fmt.Sprintf("å·²å¯¼å‡º: %s", filename))
	}

	if exportedCount == 0 {
		siyuan.æ—¥å¿—ä¿¡æ¯("æ²¡æœ‰æˆåŠŸå¯¼å‡ºä»»ä½•æ–‡æ¡£")
		return nil
	}

	siyuan.æ—¥å¿—ä¿¡æ¯(fmt.Sprintf("å…±å¯¼å‡º %d ä¸ªæ–‡æ¡£ï¼Œå¼€å§‹ Git æäº¤...", exportedCount))

	// 4. Git æ“ä½œ
	// 4.1 git add
	addCmd := safeexec.Command("git", "-C", GitRepoDir, "add", ".")
	if output, err := addCmd.CombinedOutput(); err != nil {
		return fmt.Errorf("git add å¤±è´¥: %v\n%s", err, string(output))
	}

	// 4.2 git commit
	commitMsg := fmt.Sprintf("è‡ªåŠ¨åŒæ­¥: %s (%d ä¸ªæ–‡æ¡£)", time.Now().Format("2006-01-02 15:04"), exportedCount)
	commitCmd := safeexec.Command("git", "-C", GitRepoDir, "commit", "-m", commitMsg)
	commitOutput, err := commitCmd.CombinedOutput()
	if err != nil {
		// å¦‚æœæ²¡æœ‰å˜æ›´ï¼Œcommit ä¼šè¿”å›é”™è¯¯ï¼Œä½†è¿™ä¸æ˜¯çœŸæ­£çš„é”™è¯¯
		if contains(string(commitOutput), "nothing to commit") {
			siyuan.æ—¥å¿—ä¿¡æ¯("æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤")
			return nil
		}
		return fmt.Errorf("git commit å¤±è´¥: %v\n%s", err, string(commitOutput))
	}

	siyuan.æ—¥å¿—ä¿¡æ¯("Git æäº¤æˆåŠŸ")

	// 4.3 git push
	pushCmd := safeexec.Command("git", "-C", GitRepoDir, "push", GitRemote, GitBranch)
	if output, err := pushCmd.CombinedOutput(); err != nil {
		return fmt.Errorf("git push å¤±è´¥: %v\n%s", err, string(output))
	}

	siyuan.æ—¥å¿—ä¿¡æ¯(fmt.Sprintf("æˆåŠŸæ¨é€åˆ° %s/%s", GitRemote, GitBranch))
	return nil
}

// sanitizeFilename ç§»é™¤æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
func sanitizeFilename(name string) string {
	result := ""
	for _, r := range name {
		if r == '/' || r == '\\' || r == ':' || r == '*' || r == '?' || r == '"' || r == '<' || r == '>' || r == '|' {
			continue
		}
		result += string(r)
	}
	if len(result) > 100 {
		result = result[:100]
	}
	return result
}

// contains æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å­ä¸²
func contains(s, substr string) bool {
	return len(s) >= len(substr) && (s == substr || len(s) > 0 && containsHelper(s, substr))
}

func containsHelper(s, substr string) bool {
	for i := 0; i <= len(s)-len(substr); i++ {
		if s[i:i+len(substr)] == substr {
			return true
		}
	}
	return false
}
```

## ä½¿ç”¨è¯´æ˜

### 1. å‰ç½®æ¡ä»¶

- ç›®æ ‡ç›®å½•å¿…é¡»æ˜¯å·²åˆå§‹åŒ–çš„ Git ä»“åº“ï¼š

  ```bash
  cd D:/notes/my-siyuan-backup
  git init
  git remote add origin https://github.com/your-username/your-repo.git
  ```
- Git å¿…é¡»å·²é…ç½®å¥½è®¤è¯ï¼ˆSSH å¯†é’¥æˆ– HTTPS å‡­æ®ï¼‰

### 2. è®¾ç½®æ–‡æ¡£å±æ€§

åœ¨æ–‡æ¡£å±æ€§ä¸­æ·»åŠ ï¼š

- â€‹`ext-lang`â€‹: `go`
- â€‹`ext-type`â€‹: `cronjob`

### 3. ä¿®æ”¹é…ç½®

æ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š

|å˜é‡|è¯´æ˜|ç¤ºä¾‹|
| ------| ------------------| ------|
|â€‹`GitRepoDir`|Git ä»“åº“æœ¬åœ°è·¯å¾„|â€‹`D:/notes/my-backup`|
|â€‹`ExportSubDir`|å¯¼å‡ºæ–‡ä»¶çš„å­ç›®å½•|â€‹`docs`|
|â€‹`GitRemote`|è¿œç¨‹ä»“åº“åç§°|â€‹`origin`|
|â€‹`GitBranch`|åˆ†æ”¯åç§°|â€‹`main`|
|â€‹`UpdatedWithinMinutes`|æ£€æŸ¥å¤šä¹…å†…çš„æ›´æ–°|â€‹`10`|

### 4. é¦–æ¬¡è¿è¡Œ

é¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œç”±äºæ¶‰åŠå¤–éƒ¨å‘½ä»¤è°ƒç”¨ï¼Œä¼šå¼¹å‡ºæˆæƒç¡®è®¤å¯¹è¯æ¡†ï¼š

> ğŸ” **ä»»åŠ¡ã€Œè‡ªåŠ¨ Git æ¨é€ã€è¯·æ±‚æ‰§è¡Œå‘½ä»¤**ï¼š  
> â€‹`git -C D:/notes/my-siyuan-backup add .`
>
> [å…è®¸] [æ‹’ç»]

ç‚¹å‡»ã€Œå…è®¸ã€åï¼Œè¯¥ä»»åŠ¡åœ¨æœ¬æ¬¡å†…æ ¸ç”Ÿå‘½å‘¨æœŸå†…ä¸å†é‡å¤è¯¢é—®ã€‚

### 5. éªŒè¯

- ä¿®æ”¹å‡ ç¯‡ç¬”è®°
- ç­‰å¾… 10 åˆ†é’Ÿï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘ä»»åŠ¡ï¼‰
- æ£€æŸ¥è¿œç¨‹ä»“åº“æ˜¯å¦æœ‰æ–°çš„æäº¤

## æ³¨æ„äº‹é¡¹

1. **Git è®¤è¯**ï¼šç¡®ä¿ Git å·²é…ç½®å¥½å…å¯†è®¤è¯ï¼ˆSSH æˆ–å‡­æ®ç®¡ç†å™¨ï¼‰
2. **å†²çªå¤„ç†**ï¼šæ­¤è„šæœ¬ä¸å¤„ç†åˆå¹¶å†²çªï¼Œå»ºè®®ä»…å•å‘åŒæ­¥
3. **å¤§å‹ä»“åº“**ï¼šé¦–æ¬¡åŒæ­¥å¯èƒ½è¾ƒæ…¢ï¼Œå»ºè®®å…ˆæ‰‹åŠ¨åˆå§‹åŒ–ä»“åº“
4. éœ€è¦ä¾èµ–s-forgeåˆ†æ”¯çš„åç«¯cron-jobåŠŸèƒ½

â€
